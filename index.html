<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>Device Payment Calculator</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    :root {
      --bg-gradient-start: #ff6b35;
      --bg-gradient-end: #f7931e;
      --card-bg: #fff;
      --text-primary: #333;
      --text-secondary: #666;
      --text-inverse: #fff;
      --border-color: #e6e6e6;
      --border-active: #ff6b35;
      --btn-gradient-start: #ff6b35;
      --btn-gradient-end: #f7931e;
      --pill-bg: #fafafa;
      --error-bg: #fff1f1;
      --error-border: #f3b6b6;
      --error-text: #7a1111;
      --highlight-bg: rgba(255,107,53,.05);
      --highlight-bg-end: rgba(247,147,30,.05);
    }

    body.dark-mode {
      --bg-gradient-start: #1a1a2e;
      --bg-gradient-end: #16213e;
      --card-bg: #0f3460;
      --text-primary: #e9e9e9;
      --text-secondary: #b0b0b0;
      --text-inverse: #fff;
      --border-color: #2a4a6f;
      --border-active: #ff6b35;
      --btn-gradient-start: #ff6b35;
      --btn-gradient-end: #f7931e;
      --pill-bg: #1a3a5c;
      --error-bg: #3d1a1a;
      --error-border: #6b2b2b;
      --error-text: #ffb3b3;
      --highlight-bg: rgba(255,107,53,.15);
      --highlight-bg-end: rgba(247,147,30,.15);
    }

    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      min-height:100vh;
      padding:12px;
      -webkit-tap-highlight-color: transparent;
      transition: background 0.3s ease;
    }
    .container{ max-width:760px; margin:0 auto; }
    .header{
      text-align:center;
      color: var(--text-inverse);
      margin:6px 0 10px;
      position: relative;
    }
    .header h1{ font-size:22px; font-weight:900; text-shadow:0 2px 4px rgba(0,0,0,.12); }
    .header p{ font-size:12px; opacity:.92; margin-top:4px; }

    .theme-toggle{
      position: absolute;
      top: 0;
      right: 0;
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 20px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.3s ease;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      min-height: 40px;
    }
    .theme-toggle:active{ transform: scale(0.95); }

    .card{
      background: var(--card-bg);
      border-radius:16px;
      padding:14px;
      box-shadow:0 10px 34px rgba(0,0,0,.14);
      transition: background 0.3s ease;
    }

    .device-toggle{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      margin-bottom:10px;
    }
    .toggle-btn{
      padding:12px 10px;
      border-radius:12px;
      border:2px solid var(--border-color);
      background: var(--card-bg);
      font-weight:900;
      font-size:14px;
      color: var(--text-secondary);
      cursor:pointer;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      min-height: 48px;
    }
    .toggle-btn:active{ transform: scale(0.98); }
    .toggle-btn.active{
      border-color: var(--border-active);
      background:linear-gradient(135deg, var(--btn-gradient-start) 0%, var(--btn-gradient-end) 100%);
      color: var(--text-inverse);
      box-shadow:0 2px 10px rgba(255,107,53,.28);
    }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:520px){ .grid2{ grid-template-columns:1fr; } }

    .input-group{ margin-bottom:10px; }
    .label{
      display:block;
      font-size:11px;
      font-weight:900;
      letter-spacing:.6px;
      text-transform:uppercase;
      color: var(--text-primary);
      margin-bottom:6px;
    }
    .help{
      font-size:11px;
      color: var(--text-secondary);
      margin-top:6px;
      line-height:1.25;
    }

    .input-wrap{ position:relative; }
    .prefix{
      position:absolute;
      left:12px;
      top:50%;
      transform:translateY(-50%);
      font-weight:900;
      color: var(--border-active);
      pointer-events:none;
      z-index: 1;
    }

    input[type="text"], input[type="number"]{
      width:100%;
      padding:12px 12px 12px 34px;
      font-size:16px;
      font-weight:900;
      border-radius:12px;
      border:2px solid var(--border-color);
      outline:none;
      background: var(--card-bg);
      color: var(--text-primary);
      appearance: none;
      transition: all 0.2s ease;
      min-height: 48px;
    }
    input:focus{
      border-color: var(--border-active);
      box-shadow:0 0 0 4px rgba(255,107,53,.12);
    }

    .pill{
      display:inline-block;
      padding:10px 12px;
      border-radius:12px;
      background: var(--pill-bg);
      border:2px solid var(--border-color);
      font-weight:900;
      font-size:14px;
      color: var(--text-primary);
      transition: all 0.3s ease;
      min-height: 48px;
      line-height: 24px;
    }

    .btnrow{
      display:flex;
      gap:8px;
      margin-top:2px;
      flex-wrap:wrap;
    }
    button{
      border:none;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
      transition:transform .1s, box-shadow .1s, opacity .1s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
      min-height: 48px;
    }
    button:active{ transform:translateY(1px); }

    .btn{
      flex: 1 1 160px;
      padding:14px;
      font-size:14px;
      letter-spacing:.6px;
      text-transform:uppercase;
      background:linear-gradient(135deg, var(--btn-gradient-start) 0%, var(--btn-gradient-end) 100%);
      color: var(--text-inverse);
      box-shadow:0 4px 14px rgba(255,107,53,.28);
    }
    .btn.secondary{
      background: var(--card-bg);
      color: var(--border-active);
      border:2px solid var(--border-active);
      box-shadow:none;
    }

    .error{
      display:none;
      margin-top:10px;
      background: var(--error-bg);
      border:2px solid var(--error-border);
      color: var(--error-text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      line-height:1.35;
      font-size:13px;
    }

    .results{ display:none; margin-top:12px; }
    .results.active{
      display:block;
      animation: slideIn 0.3s ease-out;
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .section-title{
      text-align:center;
      font-weight:900;
      color: var(--text-primary);
      font-size:13px;
      margin:10px 0 8px;
      letter-spacing:.4px;
    }

    .cards{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }
    .mini-card{
      border-radius:14px;
      border:2px solid var(--border-color);
      padding:10px;
      text-align:center;
      background: var(--card-bg);
    }
    .mini-card.highlight{
      border-color: var(--border-active);
      background:linear-gradient(135deg, var(--highlight-bg), var(--highlight-bg-end));
      box-shadow:0 4px 16px rgba(255, 107, 53, 0.10);
    }
    .mini-title{
      font-size:11px;
      font-weight:900;
      color: var(--border-active);
      text-transform:uppercase;
      letter-spacing:.8px;
      margin-bottom:6px;
    }
    .mini-value{
      font-size:22px;
      font-weight:900;
      color: var(--text-primary);
      margin-bottom:2px;
    }
    .mini-sub{
      font-size:10px;
      color: var(--text-secondary);
      text-transform:uppercase;
      letter-spacing:.6px;
    }

    .note{
      display:none;
      margin-top:8px;
      text-align:center;
      font-size:12px;
      color: var(--text-primary);
      line-height:1.35;
    }
    .note b{ font-weight:900; }

    .accessory-box{
      border:2px dashed var(--border-color);
      border-radius:14px;
      padding:12px;
      margin-top:8px;
    }
    .checkrow{
      display:flex;
      gap:14px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:6px;
    }
    .checkrow label{
      font-size:12px;
      font-weight:800;
      color: var(--text-primary);
      display:flex;
      gap:8px;
      align-items:center;
    }

    @media (max-width:420px){
      .cards{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle theme">üåô</button>
      <h1>Device Payment Calculator</h1>
      <p>Accessories: AARP/USAA = 30% off eligible accessories. Apple/Audio = no discount.</p>
    </div>

    <div class="card">
      <div class="device-toggle" role="tablist" aria-label="Device type">
        <button class="toggle-btn active" id="phoneBtn" type="button">üì± Phone</button>
        <button class="toggle-btn" id="watchBtn" type="button">‚åö Watch</button>
      </div>

      <div class="input-group">
        <label class="label" for="retailPrice">Retail Price</label>
        <div class="input-wrap">
          <span class="prefix" aria-hidden="true">$</span>
          <input
            type="text"
            id="retailPrice"
            placeholder="0"
            inputmode="decimal"
            autocomplete="off"
            autocapitalize="off"
            spellcheck="false"
            aria-describedby="retailHelp"
          />
        </div>
        <div class="help" id="retailHelp">Tip: For phones, retail is rounded to a whole dollar.</div>
      </div>

      <div class="accessory-box">
        <div class="grid2">
          <div class="input-group" style="margin-bottom:0;">
            <label class="label" for="accSubtotal">Accessory Price (Subtotal)</label>
            <div class="input-wrap">
              <span class="prefix" aria-hidden="true">$</span>
              <input
                type="text"
                id="accSubtotal"
                placeholder="0"
                inputmode="decimal"
                autocomplete="off"
                autocapitalize="off"
                spellcheck="false"
              />
            </div>
            <div class="help">Enter accessory subtotal (before discount).</div>
          </div>

          <div class="input-group" style="margin-bottom:0;">
            <label class="label">Accessory Type</label>
            <div class="checkrow">
              <label><input type="checkbox" id="accAppleAudio" /> Apple or Audio (no discount)</label>
            </div>
            <div class="help">If checked, discount will not apply.</div>
          </div>
        </div>

        <div class="checkrow">
          <label><input type="checkbox" id="aarpUsaa" /> AARP/USAA (30% off eligible accessories)</label>
          <label><input type="checkbox" id="includeAccInTotals" checked /> Include accessories in today totals</label>
        </div>

        <div class="help">
          Accessories are <b>not financed</b>. Monthly payment is always device-only.
          The toggle only controls whether accessories are included in the top ‚ÄúDue Today / Pay in Full‚Äù totals.
        </div>
      </div>

      <div class="grid2" style="margin-top:10px;">
        <div class="input-group">
          <label class="label" for="taxRate">Tax Rate (%)</label>
          <div class="input-wrap">
            <span class="prefix" aria-hidden="true">%</span>
            <input
              type="number"
              id="taxRate"
              value="8.9"
              step="0.01"
              min="0"
              max="100"
              inputmode="decimal"
            />
          </div>
          <div class="help">Enter your local tax rate (example: <b>8.9</b>).</div>
        </div>

        <div class="input-group">
          <label class="label">Term</label>
          <div class="pill">24 months</div>
          <div class="help">Fixed term.</div>
        </div>
      </div>

      <div class="btnrow">
        <button class="btn" type="button" id="calcBtn">Calculate</button>
        <button class="btn secondary" id="copyBtn" type="button">Copy Summary</button>
        <button class="btn secondary" type="button" id="resetBtn">Reset</button>
      </div>

      <div class="error" id="errorBox"></div>

      <div class="results" id="results">
        <div class="section-title">At a Glance</div>

        <div class="cards">
          <div class="mini-card">
            <div class="mini-title">Pay in Full Today</div>
            <div class="mini-value" id="payFullToday">$0.00</div>
            <div class="mini-sub" id="payFullSub">Device + tax (or + accessories)</div>
          </div>

          <div class="mini-card highlight">
            <div class="mini-title">Due Today</div>
            <div class="mini-value" id="dueToday">$0.00</div>
            <div class="mini-sub" id="dueSub">Down + tax (or + accessories)</div>
          </div>
        </div>

        <div class="cards" style="margin-bottom:6px;">
          <div class="mini-card">
            <div class="mini-title">Monthly Payment</div>
            <div class="mini-value" id="infoMonthly">$0.00</div>
            <div class="mini-sub">Device only</div>
          </div>
          <div class="mini-card">
            <div class="mini-title">Remaining Balance</div>
            <div class="mini-value" id="infoBalance">$0.00</div>
            <div class="mini-sub">Device only</div>
          </div>
          <div class="mini-card">
            <div class="mini-title">Down Payment</div>
            <div class="mini-value" id="infoDown">$0.00</div>
            <div class="mini-sub" id="downSub">Auto</div>
          </div>
          <div class="mini-card">
            <div class="mini-title">Device Tax</div>
            <div class="mini-value" id="deviceTax">$0.00</div>
            <div class="mini-sub">On device</div>
          </div>
        </div>

        <div class="cards" style="margin-bottom:6px;">
          <div class="mini-card">
            <div class="mini-title">Accessory Total</div>
            <div class="mini-value" id="accTotal">$0.00</div>
            <div class="mini-sub" id="accSub">After discount</div>
          </div>
          <div class="mini-card">
            <div class="mini-title">Accessory Tax</div>
            <div class="mini-value" id="accTax">$0.00</div>
            <div class="mini-sub" id="accTaxSub">On accessories</div>
          </div>
        </div>

        <div class="note" id="roundingNote"></div>
      </div>
    </div>
  </div>

  <script>
    const TERM = 24;
    const DISCOUNT_RATE = 0.30;
    let currentDeviceType = 'phone';
    let autoTimer = null;

    const retailPriceInput = document.getElementById('retailPrice');
    const accSubtotalInput = document.getElementById('accSubtotal');
    const accAppleAudioChk = document.getElementById('accAppleAudio');
    const aarpUsaaChk = document.getElementById('aarpUsaa');
    const includeAccInTotalsChk = document.getElementById('includeAccInTotals');

    const taxRateInput = document.getElementById('taxRate');
    const results = document.getElementById('results');
    const errorBox = document.getElementById('errorBox');
    const roundingNoteDiv = document.getElementById('roundingNote');
    const retailHelp = document.getElementById('retailHelp');
    const copyBtn = document.getElementById('copyBtn');
    const phoneBtn = document.getElementById('phoneBtn');
    const watchBtn = document.getElementById('watchBtn');
    const calcBtn = document.getElementById('calcBtn');
    const resetBtn = document.getElementById('resetBtn');
    const themeToggle = document.getElementById('themeToggle');

    function money(n){
      if (isNaN(n) || !isFinite(n)) return '$0.00';
      return n.toLocaleString('en-US', { style:'currency', currency:'USD', minimumFractionDigits:2, maximumFractionDigits:2 });
    }
    function round2(n){ if (isNaN(n)) return 0; return Math.round((n + Number.EPSILON) * 100) / 100; }
    function ceil2(n){ if (isNaN(n)) return 0; return Math.ceil(n * 100) / 100; }

    function showError(msg){ errorBox.style.display='block'; errorBox.textContent=msg; }
    function clearError(){ errorBox.style.display='none'; errorBox.textContent=''; }

    function toggleTheme(){
      const isDark = document.body.classList.toggle('dark-mode');
      themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      try { localStorage.setItem('dpc_theme', isDark ? 'dark' : 'light'); } catch(e){}
    }

    function phoneDownPayment(retailWhole){
      let down = ((retailWhole % TERM) + TERM) % TERM;
      if (down < 11) down += TERM;
      return down;
    }

    function setDeviceType(type){
      currentDeviceType = type;
      phoneBtn.classList.toggle('active', type === 'phone');
      watchBtn.classList.toggle('active', type === 'watch');

      retailHelp.textContent = (type === 'phone')
        ? "Tip: For phones, retail is rounded to a whole dollar."
        : "Tip: Watches can include cents. Monthly is rounded up to the nearest cent.";

      try { localStorage.setItem('dpc_deviceType', type); } catch(e){}
      scheduleAutoCalc();
    }

    function sanitizeMoneyInput(inputEl){
      const raw = inputEl.value;
      let cleaned = raw.replace(/[^0-9.]/g, '');
      const firstDot = cleaned.indexOf('.');
      if (firstDot !== -1){
        cleaned = cleaned.slice(0, firstDot + 1) + cleaned.slice(firstDot + 1).replace(/\./g, '');
      }
      if (cleaned !== raw){
        const pos = inputEl.selectionStart || cleaned.length;
        inputEl.value = cleaned;
        try { inputEl.setSelectionRange(pos, pos); } catch(e){}
      }
    }

    function parseMoney(inputEl){
      const v = (inputEl.value || '').trim();
      const n = parseFloat(v);
      return (isFinite(n) ? n : 0);
    }

    function scheduleAutoCalc(){
      if (autoTimer) clearTimeout(autoTimer);
      autoTimer = setTimeout(() => {
        if (retailPriceInput.value.trim()) calculate(false);
      }, 250);
    }

    function calculate(userInitiated = false){
      clearError();
      roundingNoteDiv.style.display = 'none';
      roundingNoteDiv.textContent = '';
      if (userInitiated) copyBtn.textContent = "Copy Summary";

      const retailInput = retailPriceInput.value.trim();
      if (!retailInput){
        if (userInitiated) { showError('Please enter a retail price.'); retailPriceInput.focus(); }
        results.classList.remove('active');
        return;
      }

      let retail = parseMoney(retailPriceInput);
      const taxRate = parseFloat(taxRateInput.value || '0');

      if (!isFinite(retail) || retail <= 0){
        showError('Please enter a valid retail price greater than $0.');
        results.classList.remove('active');
        return;
      }
      if (!isFinite(taxRate) || taxRate < 0 || taxRate > 100){
        showError('Tax rate must be between 0% and 100%.');
        results.classList.remove('active');
        return;
      }

      if (currentDeviceType === 'phone'){
        retail = Math.round(retail);
        if (userInitiated) retailPriceInput.value = retail.toString();
      } else {
        retail = round2(retail);
        if (userInitiated) retailPriceInput.value = retail.toFixed(2);
      }

      // Accessories
      const accSubtotal = round2(parseMoney(accSubtotalInput));
      const isAppleAudio = !!accAppleAudioChk.checked;
      const aarp = !!aarpUsaaChk.checked;

      const discountEligible = aarp && accSubtotal > 0 && !isAppleAudio;
      const accDiscount = discountEligible ? round2(accSubtotal * DISCOUNT_RATE) : 0;
      const accAfterDiscount = round2(accSubtotal - accDiscount);

      // Taxes
      const deviceTax = round2(retail * (taxRate / 100));
      const accessoryTax = round2(accAfterDiscount * (taxRate / 100));

      // Device financing
      let down = 0, balance = 0, monthlyDisplay = 0;

      if (currentDeviceType === 'watch'){
        down = 0;
        balance = retail;
        monthlyDisplay = ceil2(balance / TERM);

        const monthlyTotalShown = round2(monthlyDisplay * TERM);
        const diff = round2(monthlyTotalShown - retail);
        if (diff >= 0.01){
          roundingNoteDiv.style.display = 'block';
          roundingNoteDiv.innerHTML =
            `Monthly is rounded up to the nearest cent. The last payment is adjusted by <b>${money(diff)}</b> so the total matches retail.`;
        }
        document.getElementById('downSub').textContent = "0";
      } else {
        down = phoneDownPayment(retail);
        if (down > retail){
          showError('Retail price is too small for the down-payment rule.');
          results.classList.remove('active');
          return;
        }
        balance = retail - down;
        monthlyDisplay = balance / TERM;
        document.getElementById('downSub').textContent = "Auto";
      }

      const includeAcc = !!includeAccInTotalsChk.checked;

      // Device-only totals
      const devicePayFull = round2(retail + deviceTax);
      const deviceDueToday = round2(down + deviceTax);

      // Accessories due today (never financed)
      const accDueToday = round2(accAfterDiscount + accessoryTax);

      // Combined totals if toggle is ON
      const payFullToday = includeAcc ? round2(devicePayFull + accDueToday) : devicePayFull;
      const dueToday = includeAcc ? round2(deviceDueToday + accDueToday) : deviceDueToday;

      // UI
      document.getElementById('payFullToday').textContent = money(payFullToday);
      document.getElementById('dueToday').textContent = money(dueToday);

      document.getElementById('payFullSub').textContent = includeAcc ? "Device + accessories + tax" : "Device + tax";
      document.getElementById('dueSub').textContent = includeAcc ? "Down + tax + accessories" : "Down + device tax";

      document.getElementById('infoMonthly').textContent = money(monthlyDisplay);
      document.getElementById('infoBalance').textContent = money(balance);
      document.getElementById('infoDown').textContent = money(down);

      document.getElementById('deviceTax').textContent = money(deviceTax);
      document.getElementById('accTotal').textContent = money(accAfterDiscount);
      document.getElementById('accTax').textContent = money(accessoryTax);

      const accSub = document.getElementById('accSub');
      const accTaxSub = document.getElementById('accTaxSub');

      if (accSubtotal <= 0){
        accSub.textContent = "No accessories";
        accTaxSub.textContent = "On accessories";
      } else if (discountEligible){
        accSub.textContent = `30% off applied (‚àí${money(accDiscount)}) ‚Ä¢ Due today: ${money(accDueToday)}`;
        accTaxSub.textContent = `Due today: ${money(accDueToday)}`;
      } else if (aarp && isAppleAudio){
        accSub.textContent = `No discount (Apple/Audio) ‚Ä¢ Due today: ${money(accDueToday)}`;
        accTaxSub.textContent = `Due today: ${money(accDueToday)}`;
      } else if (aarp && !isAppleAudio){
        accSub.textContent = `Discount not applied (unchecked?) ‚Ä¢ Due today: ${money(accDueToday)}`;
        accTaxSub.textContent = `Due today: ${money(accDueToday)}`;
      } else {
        accSub.textContent = `Due today: ${money(accDueToday)}`;
        accTaxSub.textContent = `Due today: ${money(accDueToday)}`;
      }

      results.classList.add('active');
    }

    function resetAll(){
      retailPriceInput.value = "";
      accSubtotalInput.value = "";
      accAppleAudioChk.checked = false;
      aarpUsaaChk.checked = false;
      includeAccInTotalsChk.checked = true;

      try {
        const savedTax = localStorage.getItem('dpc_taxRate');
        taxRateInput.value = savedTax ? savedTax : "8.90";
      } catch(e){
        taxRateInput.value = "8.90";
      }

      setDeviceType('phone');
      results.classList.remove('active');
      clearError();
      roundingNoteDiv.style.display = 'none';
      copyBtn.textContent = "Copy Summary";
      setTimeout(() => retailPriceInput.focus(), 50);
    }

    async function copySummary(){
      calculate(true);

      let retail = parseMoney(retailPriceInput);
      const taxRate = parseFloat(taxRateInput.value || '0');
      if (!retail || retail <= 0) { showError('Enter a retail price to copy summary.'); return; }

      if (currentDeviceType === 'phone') retail = Math.round(retail);
      else retail = round2(retail);

      const accSubtotal = round2(parseMoney(accSubtotalInput));
      const isAppleAudio = !!accAppleAudioChk.checked;
      const aarp = !!aarpUsaaChk.checked;
      const includeAcc = !!includeAccInTotalsChk.checked;

      const discountEligible = aarp && accSubtotal > 0 && !isAppleAudio;
      const accDiscount = discountEligible ? round2(accSubtotal * DISCOUNT_RATE) : 0;
      const accAfterDiscount = round2(accSubtotal - accDiscount);

      const deviceTax = round2(retail * (taxRate / 100));
      const accessoryTax = round2(accAfterDiscount * (taxRate / 100));
      const accDueToday = round2(accAfterDiscount + accessoryTax);

      let down = 0, balance = 0, monthly = 0;
      if (currentDeviceType === 'watch'){
        down = 0;
        balance = retail;
        monthly = ceil2(balance / TERM);
      } else {
        down = phoneDownPayment(retail);
        balance = retail - down;
        monthly = balance / TERM;
      }

      const devicePayFull = round2(retail + deviceTax);
      const deviceDueToday = round2(down + deviceTax);

      const payFullToday = includeAcc ? round2(devicePayFull + accDueToday) : devicePayFull;
      const dueToday = includeAcc ? round2(deviceDueToday + accDueToday) : deviceDueToday;

      const text =
`Device + Accessories Summary
Type: ${currentDeviceType === 'watch' ? 'Watch' : 'Phone'}
Retail: ${money(retail)}
Tax rate: ${taxRate.toFixed(2)}%
Device tax: ${money(deviceTax)}

Accessories subtotal: ${money(accSubtotal)}
Apple/Audio accessory: ${isAppleAudio ? 'Yes' : 'No'}
AARP/USAA: ${aarp ? 'Yes (30% eligible)' : 'No'}
Accessory discount: ${money(accDiscount)}
Accessory total (after discount): ${money(accAfterDiscount)}
Accessory tax: ${money(accessoryTax)}
Accessories due today: ${money(accDueToday)}

Include accessories in totals: ${includeAcc ? 'Yes' : 'No'}
Pay in full today: ${money(payFullToday)}
Due today: ${money(dueToday)}

Monthly payment (device only): ${money(monthly)} x 24
Remaining balance (device only): ${money(balance)}
Down payment: ${money(down)}`;

      try{
        await navigator.clipboard.writeText(text);
        const originalText = copyBtn.textContent;
        copyBtn.textContent = "‚úì Copied!";
        setTimeout(() => copyBtn.textContent = originalText, 1600);
      }catch(e){
        const ta = document.createElement('textarea');
        ta.value = text;
        ta.style.position = 'fixed';
        ta.style.left = '-9999px';
        document.body.appendChild(ta);
        ta.select();
        try { document.execCommand('copy'); copyBtn.textContent = "‚úì Copied!"; }
        catch(err) { showError('Copy failed.'); }
        document.body.removeChild(ta);
        setTimeout(() => copyBtn.textContent = "Copy Summary", 1600);
      }
    }

    phoneBtn.addEventListener('click', (e) => { e.preventDefault(); setDeviceType('phone'); });
    watchBtn.addEventListener('click', (e) => { e.preventDefault(); setDeviceType('watch'); });
    calcBtn.addEventListener('click', (e) => { e.preventDefault(); calculate(true); });
    copyBtn.addEventListener('click', (e) => { e.preventDefault(); copySummary(); });
    resetBtn.addEventListener('click', (e) => { e.preventDefault(); resetAll(); });
    themeToggle.addEventListener('click', (e) => { e.preventDefault(); toggleTheme(); });

    [retailPriceInput, accSubtotalInput].forEach(el => {
      el.addEventListener('input', () => { sanitizeMoneyInput(el); scheduleAutoCalc(); });
      el.addEventListener('blur', () => calculate(false));
    });
    [taxRateInput, aarpUsaaChk, accAppleAudioChk, includeAccInTotalsChk].forEach(el => {
      el.addEventListener('input', scheduleAutoCalc);
      el.addEventListener('change', scheduleAutoCalc);
      el.addEventListener('blur', () => calculate(false));
    });

    window.addEventListener('load', () => {
      try{
        const savedTheme = localStorage.getItem('dpc_theme');
        if (savedTheme === 'dark') { document.body.classList.add('dark-mode'); themeToggle.textContent = '‚òÄÔ∏è'; }

        const savedTax = localStorage.getItem('dpc_taxRate');
        if (savedTax) taxRateInput.value = savedTax;

        const savedType = localStorage.getItem('dpc_deviceType');
        if (savedType === 'watch' || savedType === 'phone') setDeviceType(savedType);
      }catch(e){}
    });
  </script>
</body>
</html>
