<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>Device Payment Calculator</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }

    :root{
      --bg1:#ff6b35; --bg2:#f7931e;
      --card:#fff;
      --text:#333; --muted:#666;
      --inv:#fff;
      --border:#e6e6e6;
      --accent:#ff6b35;
      --pill:#fafafa;
      --errbg:#fff1f1; --errbd:#f3b6b6; --err:#7a1111;
      --hil1: rgba(255,107,53,.05);
      --hil2: rgba(247,147,30,.05);
    }

    body.dark-mode{
      --bg1:#1a1a2e; --bg2:#16213e;
      --card:#0f3460;
      --text:#e9e9e9; --muted:#b0b0b0;
      --inv:#fff;
      --border:#2a4a6f;
      --accent:#ff6b35;
      --pill:#1a3a5c;
      --errbg:#3d1a1a; --errbd:#6b2b2b; --err:#ffb3b3;
      --hil1: rgba(255,107,53,.15);
      --hil2: rgba(247,147,30,.15);
    }

    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);
      min-height:100vh;
      padding:12px;
      -webkit-tap-highlight-color:transparent;
      transition:background .3s ease;
    }

    .container{ max-width:860px; margin:0 auto; }
    .header{ text-align:center; color:var(--inv); margin:6px 0 10px; position:relative; }
    .header h1{ font-size:22px; font-weight:900; text-shadow:0 2px 4px rgba(0,0,0,.12); }
    .header p{ font-size:12px; opacity:.92; margin-top:4px; }

    .theme-toggle{
      position:absolute; top:0; right:0;
      background:rgba(255,255,255,.2);
      border:2px solid rgba(255,255,255,.3);
      border-radius:20px;
      padding:6px 12px;
      cursor:pointer;
      font-size:18px;
      min-height:40px;
    }
    .theme-toggle:active{ transform:scale(.95); }

    .card{
      background:var(--card);
      border-radius:16px;
      padding:14px;
      box-shadow:0 10px 34px rgba(0,0,0,.14);
      transition:background .3s ease;
    }

    .device-toggle{ display:grid; grid-template-columns:1fr 1fr; gap:8px; margin-bottom:10px; }
    .toggle-btn{
      padding:12px 10px;
      border-radius:12px;
      border:2px solid var(--border);
      background:var(--card);
      font-weight:900;
      font-size:14px;
      color:var(--muted);
      cursor:pointer;
      min-height:48px;
    }
    .toggle-btn:active{ transform:scale(.98); }
    .toggle-btn.active{
      border-color:var(--accent);
      background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);
      color:var(--inv);
      box-shadow:0 2px 10px rgba(255,107,53,.28);
    }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:520px){ .grid2{ grid-template-columns:1fr; } }

    .input-group{ margin-bottom:10px; }
    .label{
      display:block; font-size:11px; font-weight:900; letter-spacing:.6px;
      text-transform:uppercase; color:var(--text); margin-bottom:6px;
    }
    .help{ font-size:11px; color:var(--muted); margin-top:6px; line-height:1.25; }

    .input-wrap{ position:relative; }
    .prefix{
      position:absolute; left:12px; top:50%;
      transform:translateY(-50%);
      font-weight:900; color:var(--accent);
      pointer-events:none; z-index:1;
    }

    input[type="text"], input[type="number"]{
      width:100%;
      padding:12px 12px 12px 34px;
      font-size:16px; /* prevents iOS zoom */
      font-weight:900;
      border-radius:12px;
      border:2px solid var(--border);
      outline:none;
      background:var(--card);
      color:var(--text);
      min-height:48px;
    }
    input:focus{ border-color:var(--accent); box-shadow:0 0 0 4px rgba(255,107,53,.12); }

    .pill{
      display:inline-block;
      padding:10px 12px;
      border-radius:12px;
      background:var(--pill);
      border:2px solid var(--border);
      font-weight:900;
      font-size:14px;
      color:var(--text);
      min-height:48px;
      line-height:24px;
    }

    .accessory-box{
      border:2px dashed var(--border);
      border-radius:14px;
      padding:12px;
      margin-top:8px;
    }

    .checkrow{
      display:flex;
      flex-wrap:wrap;
      gap:14px;
      align-items:center;
      margin-top:8px;
    }
    .checkrow label{
      display:flex; align-items:center; gap:8px;
      font-size:12px; font-weight:800; color:var(--text);
    }

    .btnrow{ display:flex; gap:8px; flex-wrap:wrap; margin-top:2px; }
    button{
      border:none; border-radius:12px; font-weight:900; cursor:pointer;
      -webkit-tap-highlight-color:transparent; touch-action:manipulation;
      min-height:48px;
    }
    button:active{ transform:translateY(1px); }

    .btn{
      flex:1 1 160px;
      padding:14px;
      font-size:14px;
      letter-spacing:.6px;
      text-transform:uppercase;
      background:linear-gradient(135deg,var(--bg1) 0%,var(--bg2) 100%);
      color:var(--inv);
      box-shadow:0 4px 14px rgba(255,107,53,.28);
    }
    .btn.secondary{
      background:var(--card);
      color:var(--accent);
      border:2px solid var(--accent);
      box-shadow:none;
    }

    .error{
      display:none;
      margin-top:10px;
      background:var(--errbg);
      border:2px solid var(--errbd);
      color:var(--err);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      line-height:1.35;
      font-size:13px;
    }

    .results{ display:none; margin-top:12px; }
    .results.active{ display:block; animation:slideIn .3s ease-out; }
    @keyframes slideIn{
      from{ opacity:0; transform:translateY(-10px); }
      to{ opacity:1; transform:translateY(0); }
    }

    .section-title{
      text-align:center;
      font-weight:900;
      color:var(--text);
      font-size:13px;
      margin:10px 0 8px;
      letter-spacing:.4px;
    }

    .cards{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }
    .mini-card{
      border-radius:14px;
      border:2px solid var(--border);
      padding:10px;
      text-align:center;
      background:var(--card);
    }
    .mini-card.highlight{
      border-color:var(--accent);
      background:linear-gradient(135deg,var(--hil1),var(--hil2));
      box-shadow:0 4px 16px rgba(255,107,53,.10);
    }
    .mini-title{
      font-size:11px;
      font-weight:900;
      color:var(--accent);
      text-transform:uppercase;
      letter-spacing:.8px;
      margin-bottom:6px;
    }
    .mini-value{ font-size:22px; font-weight:900; color:var(--text); margin-bottom:2px; }
    .mini-sub{ font-size:10px; color:var(--muted); text-transform:uppercase; letter-spacing:.6px; }

    .note{
      display:none;
      margin-top:8px;
      text-align:center;
      font-size:12px;
      color:var(--text);
      line-height:1.35;
    }

    @media (max-width:420px){
      .cards{ grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle theme">üåô</button>
      <h1>Device Payment Calculator</h1>
      <p>Accessories are separate (not financed). You can optionally add accessory total to Device Due Today / Pay in Full.</p>
    </div>

    <div class="card">
      <div class="device-toggle" role="tablist" aria-label="Device type">
        <button class="toggle-btn active" id="phoneBtn" type="button">üì± Phone</button>
        <button class="toggle-btn" id="watchBtn" type="button">‚åö Watch</button>
      </div>

      <!-- DEVICE -->
      <div class="input-group">
        <label class="label" for="retailPrice">Device Retail Price</label>
        <div class="input-wrap">
          <span class="prefix" aria-hidden="true">$</span>
          <input
            type="text"
            id="retailPrice"
            placeholder="0"
            inputmode="decimal"
            autocomplete="off"
            autocapitalize="off"
            spellcheck="false"
          />
        </div>
        <div class="help" id="retailHelp">Tip: For phones, retail is rounded to a whole dollar.</div>
      </div>

      <!-- ACCESSORIES -->
      <div class="accessory-box">
        <div class="grid2">
          <div class="input-group" style="margin-bottom:0;">
            <label class="label" for="accEligible">Eligible Accessories Subtotal</label>
            <div class="input-wrap">
              <span class="prefix" aria-hidden="true">$</span>
              <input type="text" id="accEligible" placeholder="0" inputmode="decimal" autocomplete="off" autocapitalize="off" spellcheck="false" />
            </div>
            <div class="help">Gets 30% discount if AARP/USAA is checked.</div>
          </div>

          <div class="input-group" style="margin-bottom:0;">
            <label class="label" for="accNoDisc">No-Discount Subtotal (Apple/Audio)</label>
            <div class="input-wrap">
              <span class="prefix" aria-hidden="true">$</span>
              <input type="text" id="accNoDisc" placeholder="0" inputmode="decimal" autocomplete="off" autocapitalize="off" spellcheck="false" />
            </div>
            <div class="help">Apple + audio accessories (no discount).</div>
          </div>
        </div>

        <div class="checkrow">
          <label><input type="checkbox" id="aarpUsaa" /> AARP/USAA (30% off eligible)</label>
        </div>

        <!-- APPLY ACCESSORY TOTALS -->
        <div class="checkrow" style="margin-top:10px;">
          <label><input type="checkbox" id="addAccToDue" /> Add accessory due-today total to <b>Device Due Today</b></label>
          <label><input type="checkbox" id="addAccToFull" /> Add accessory due-today total to <b>Pay in Full Today</b></label>
        </div>
        <div class="help">
          You can calculate accessories with <b>no device entered</b>. These checkboxes only control whether accessory totals get added into the device totals.
        </div>
      </div>

      <!-- TAX / TERM -->
      <div class="grid2" style="margin-top:10px;">
        <div class="input-group">
          <label class="label" for="taxRate">Tax Rate (%)</label>
          <div class="input-wrap">
            <span class="prefix" aria-hidden="true">%</span>
            <input type="number" id="taxRate" value="8.9" step="0.01" min="0" max="100" inputmode="decimal" />
          </div>
          <div class="help">Enter your local tax rate (example: <b>8.9</b>).</div>
        </div>

        <div class="input-group">
          <label class="label">Term</label>
          <div class="pill">24 months</div>
          <div class="help">Fixed term.</div>
        </div>
      </div>

      <div class="btnrow">
        <button class="btn" type="button" id="calcBtn">Calculate</button>
        <button class="btn secondary" id="copyBtn" type="button">Copy Summary</button>
        <button class="btn secondary" type="button" id="resetBtn">Reset</button>
      </div>

      <div class="error" id="errorBox"></div>

      <div class="results" id="results">
        <div class="section-title" id="headline">Results</div>

        <!-- TOP TOTALS -->
        <div class="cards">
          <div class="mini-card">
            <div class="mini-title" id="titlePayFull">Pay in Full Today</div>
            <div class="mini-value" id="payFullToday">$0.00</div>
            <div class="mini-sub" id="payFullSub">Device + tax</div>
          </div>

          <div class="mini-card highlight">
            <div class="mini-title" id="titleDueToday">Due Today</div>
            <div class="mini-value" id="dueToday">$0.00</div>
            <div class="mini-sub" id="dueSub">Down + device tax</div>
          </div>
        </div>

        <!-- DEVICE CARDS (HIDDEN IN ACCESSORY-ONLY MODE) -->
        <div id="deviceCards">
          <div class="cards" style="margin-bottom:6px;">
            <div class="mini-card">
              <div class="mini-title">Monthly Payment</div>
              <div class="mini-value" id="infoMonthly">$0.00</div>
              <div class="mini-sub">Device only</div>
            </div>
            <div class="mini-card">
              <div class="mini-title">Remaining Balance</div>
              <div class="mini-value" id="infoBalance">$0.00</div>
              <div class="mini-sub">Device only</div>
            </div>
            <div class="mini-card">
              <div class="mini-title">Down Payment</div>
              <div class="mini-value" id="infoDown">$0.00</div>
              <div class="mini-sub" id="downSub">Auto</div>
            </div>
            <div class="mini-card">
              <div class="mini-title">Device Tax</div>
              <div class="mini-value" id="deviceTax">$0.00</div>
              <div class="mini-sub">On device</div>
            </div>
          </div>

          <div class="note" id="roundingNote"></div>
        </div>

        <!-- ACCESSORY CARDS (ALWAYS AVAILABLE) -->
        <div class="cards" style="margin-bottom:6px;">
          <div class="mini-card">
            <div class="mini-title">Accessories Total</div>
            <div class="mini-value" id="accTotal">$0.00</div>
            <div class="mini-sub" id="accSub">After discount</div>
          </div>
          <div class="mini-card">
            <div class="mini-title">Accessories Due Today</div>
            <div class="mini-value" id="accDueToday">$0.00</div>
            <div class="mini-sub" id="accDueSub">Includes tax</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const TERM = 24;
    const DISCOUNT_RATE = 0.30;
    let currentDeviceType = 'phone';
    let autoTimer = null;

    const retailPriceInput = document.getElementById('retailPrice');
    const accEligibleInput = document.getElementById('accEligible');
    const accNoDiscInput = document.getElementById('accNoDisc');
    const aarpUsaaChk = document.getElementById('aarpUsaa');
    const addAccToDueChk = document.getElementById('addAccToDue');
    const addAccToFullChk = document.getElementById('addAccToFull');

    const taxRateInput = document.getElementById('taxRate');
    const results = document.getElementById('results');
    const errorBox = document.getElementById('errorBox');

    const deviceCards = document.getElementById('deviceCards');
    const roundingNoteDiv = document.getElementById('roundingNote');
    const retailHelp = document.getElementById('retailHelp');
    const copyBtn = document.getElementById('copyBtn');

    const phoneBtn = document.getElementById('phoneBtn');
    const watchBtn = document.getElementById('watchBtn');
    const calcBtn = document.getElementById('calcBtn');
    const resetBtn = document.getElementById('resetBtn');
    const themeToggle = document.getElementById('themeToggle');

    const titlePayFull = document.getElementById('titlePayFull');
    const titleDueToday = document.getElementById('titleDueToday');
    const payFullSub = document.getElementById('payFullSub');
    const dueSub = document.getElementById('dueSub');
    const headline = document.getElementById('headline');

    function money(n){
      if (isNaN(n) || !isFinite(n)) return '$0.00';
      return n.toLocaleString('en-US', { style:'currency', currency:'USD', minimumFractionDigits:2, maximumFractionDigits:2 });
    }
    function round2(n){ if (isNaN(n)) return 0; return Math.round((n + Number.EPSILON) * 100) / 100; }
    function ceil2(n){ if (isNaN(n)) return 0; return Math.ceil(n * 100) / 100; }

    function showError(msg){ errorBox.style.display='block'; errorBox.textContent=msg; }
    function clearError(){ errorBox.style.display='none'; errorBox.textContent=''; }

    function toggleTheme(){
      const isDark = document.body.classList.toggle('dark-mode');
      themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      try { localStorage.setItem('dpc_theme', isDark ? 'dark' : 'light'); } catch(e){}
    }

    function phoneDownPayment(retailWhole){
      let down = ((retailWhole % TERM) + TERM) % TERM;
      if (down < 11) down += TERM;
      return down;
    }

    function setDeviceType(type){
      currentDeviceType = type;
      phoneBtn.classList.toggle('active', type === 'phone');
      watchBtn.classList.toggle('active', type === 'watch');

      retailHelp.textContent = (type === 'phone')
        ? "Tip: For phones, retail is rounded to a whole dollar."
        : "Tip: Watches can include cents. Monthly is rounded up to the nearest cent.";

      try { localStorage.setItem('dpc_deviceType', type); } catch(e){}
      scheduleAutoCalc();
    }

    // Strong sanitizer: numbers + one dot only (prevents letters like "p")
    function sanitizeMoneyInput(inputEl){
      const raw = inputEl.value;
      let cleaned = raw.replace(/[^0-9.]/g, '');
      const firstDot = cleaned.indexOf('.');
      if (firstDot !== -1){
        cleaned = cleaned.slice(0, firstDot + 1) + cleaned.slice(firstDot + 1).replace(/\./g, '');
      }
      if (cleaned !== raw){
        const pos = inputEl.selectionStart || cleaned.length;
        inputEl.value = cleaned;
        try { inputEl.setSelectionRange(pos, pos); } catch(e){}
      }
    }

    function parseMoney(inputEl){
      const v = (inputEl.value || '').trim();
      const n = parseFloat(v);
      return (isFinite(n) ? n : 0);
    }

    function scheduleAutoCalc(){
      if (autoTimer) clearTimeout(autoTimer);
      autoTimer = setTimeout(() => {
        // auto-calc when either device OR accessories present
        if (retailPriceInput.value.trim() || accEligibleInput.value.trim() || accNoDiscInput.value.trim()) {
          calculate(false);
        } else {
          results.classList.remove('active');
          clearError();
        }
      }, 250);
    }

    function calculate(userInitiated = false){
      clearError();
      roundingNoteDiv.style.display = 'none';
      roundingNoteDiv.textContent = '';
      copyBtn.textContent = "Copy Summary";

      const taxRate = parseFloat(taxRateInput.value || '0');
      if (!isFinite(taxRate) || taxRate < 0 || taxRate > 100){
        showError('Tax rate must be between 0% and 100%.');
        results.classList.remove('active');
        return;
      }

      // Accessories (always calculable)
      const eligibleSub = round2(parseMoney(accEligibleInput));
      const noDiscSub = round2(parseMoney(accNoDiscInput));
      const aarp = !!aarpUsaaChk.checked;

      const disc = (aarp && eligibleSub > 0) ? round2(eligibleSub * DISCOUNT_RATE) : 0;
      const eligibleAfter = round2(eligibleSub - disc);
      const accessoriesTotal = round2(eligibleAfter + noDiscSub);
      const accessoryTax = round2(accessoriesTotal * (taxRate / 100));
      const accessoriesDueToday = round2(accessoriesTotal + accessoryTax);

      // Device (optional)
      const retailRaw = round2(parseMoney(retailPriceInput));
      const deviceEnabled = retailRaw > 0;

      // If neither device nor accessories entered
      if (!deviceEnabled && accessoriesTotal <= 0){
        if (userInitiated) showError('Enter a device retail price or accessory amounts.');
        results.classList.remove('active');
        return;
      }

      // Fill accessory cards
      document.getElementById('accTotal').textContent = money(accessoriesTotal);
      document.getElementById('accDueToday').textContent = money(accessoriesDueToday);

      const accSub = document.getElementById('accSub');
      const accDueSub = document.getElementById('accDueSub');

      if (eligibleSub === 0 && noDiscSub === 0){
        accSub.textContent = "No accessories";
        accDueSub.textContent = "Includes tax";
      } else {
        const parts = [];
        if (eligibleSub > 0) parts.push(`Eligible: ${money(eligibleAfter)}`);
        if (noDiscSub > 0) parts.push(`No-discount: ${money(noDiscSub)}`);
        if (disc > 0) parts.push(`Discount: ‚àí${money(disc)}`);
        accSub.textContent = parts.join(" ‚Ä¢ ");
        accDueSub.textContent = `Tax: ${money(accessoryTax)}`;
      }

      // Accessory-only mode
      if (!deviceEnabled){
        deviceCards.style.display = 'none';
        headline.textContent = "Accessory Quote";

        titlePayFull.textContent = "Accessory Total Today";
        titleDueToday.textContent = "Accessory Due Today";

        document.getElementById('payFullToday').textContent = money(accessoriesDueToday);
        document.getElementById('dueToday').textContent = money(accessoriesDueToday);

        payFullSub.textContent = "Accessories + tax";
        dueSub.textContent = "Accessories + tax";

        results.classList.add('active');
        return;
      }

      // Device calculations
      deviceCards.style.display = 'block';
      headline.textContent = "Device + Accessories Quote";

      let retail = retailRaw;
      // normalize retail for device math and optionally format input on button press
      if (currentDeviceType === 'phone'){
        retail = Math.round(retail);
        if (userInitiated) retailPriceInput.value = retail.toString();
      } else {
        retail = round2(retail);
        if (userInitiated) retailPriceInput.value = retail.toFixed(2);
      }

      const deviceTax = round2(retail * (taxRate / 100));

      let down = 0, balance = 0, monthlyDisplay = 0;
      if (currentDeviceType === 'watch'){
        down = 0;
        balance = retail;
        monthlyDisplay = ceil2(balance / TERM);

        const monthlyTotalShown = round2(monthlyDisplay * TERM);
        const diff = round2(monthlyTotalShown - retail);
        if (diff >= 0.01){
          roundingNoteDiv.style.display = 'block';
          roundingNoteDiv.innerHTML =
            `Monthly is rounded up to the nearest cent. The last payment is adjusted by <b>${money(diff)}</b> so the total matches retail.`;
        }
        document.getElementById('downSub').textContent = "0";
      } else {
        down = phoneDownPayment(retail);
        balance = retail - down;
        monthlyDisplay = balance / TERM;
        document.getElementById('downSub').textContent = "Auto";
      }

      const devicePayFull = round2(retail + deviceTax);
      const deviceDueToday = round2(down + deviceTax);

      // Apply accessory due-today total into device totals based on checkboxes
      const payFullToday = addAccToFullChk.checked ? round2(devicePayFull + accessoriesDueToday) : devicePayFull;
      const dueToday = addAccToDueChk.checked ? round2(deviceDueToday + accessoriesDueToday) : deviceDueToday;

      // Update top labels
      titlePayFull.textContent = "Pay in Full Today";
      titleDueToday.textContent = "Due Today";
      payFullSub.textContent = addAccToFullChk.checked ? "Device + tax + accessories" : "Device + tax";
      dueSub.textContent = addAccToDueChk.checked ? "Down + device tax + accessories" : "Down + device tax";

      // Fill device cards
      document.getElementById('payFullToday').textContent = money(payFullToday);
      document.getElementById('dueToday').textContent = money(dueToday);

      document.getElementById('infoMonthly').textContent = money(monthlyDisplay);
      document.getElementById('infoBalance').textContent = money(balance);
      document.getElementById('infoDown').textContent = money(down);
      document.getElementById('deviceTax').textContent = money(deviceTax);

      results.classList.add('active');
    }

    function resetAll(){
      retailPriceInput.value = "";
      accEligibleInput.value = "";
      accNoDiscInput.value = "";
      aarpUsaaChk.checked = false;
      addAccToDueChk.checked = false;
      addAccToFullChk.checked = false;

      try {
        const savedTax = localStorage.getItem('dpc_taxRate');
        taxRateInput.value = savedTax ? savedTax : "8.90";
      } catch(e){
        taxRateInput.value = "8.90";
      }

      setDeviceType('phone');
      results.classList.remove('active');
      clearError();
      roundingNoteDiv.style.display = 'none';
      copyBtn.textContent = "Copy Summary";
      deviceCards.style.display = 'block';
      setTimeout(() => retailPriceInput.focus(), 50);
    }

    async function copySummary(){
      // Force calculation first
      calculate(true);

      const taxRate = parseFloat(taxRateInput.value || '0');
      const eligibleSub = round2(parseMoney(accEligibleInput));
      const noDiscSub = round2(parseMoney(accNoDiscInput));
      const aarp = !!aarpUsaaChk.checked;

      const disc = (aarp && eligibleSub > 0) ? round2(eligibleSub * DISCOUNT_RATE) : 0;
      const eligibleAfter = round2(eligibleSub - disc);
      const accessoriesTotal = round2(eligibleAfter + noDiscSub);
      const accessoryTax = round2(accessoriesTotal * (taxRate / 100));
      const accessoriesDueToday = round2(accessoriesTotal + accessoryTax);

      const retailRaw = round2(parseMoney(retailPriceInput));
      const deviceEnabled = retailRaw > 0;

      let text = `Accessory Summary\nEligible subtotal: ${money(eligibleSub)}\nNo-discount subtotal: ${money(noDiscSub)}\nAARP/USAA: ${aarp ? 'Yes' : 'No'}\nDiscount: ${money(disc)}\nAccessories total: ${money(accessoriesTotal)}\nAccessory tax: ${money(accessoryTax)}\nAccessories due today: ${money(accessoriesDueToday)}\n\n`;

      if (!deviceEnabled){
        text += `MODE: Accessory-only\nTotal today: ${money(accessoriesDueToday)}\n`;
      } else {
        let retail = retailRaw;
        if (currentDeviceType === 'phone') retail = Math.round(retail);
        else retail = round2(retail);

        const deviceTax = round2(retail * (taxRate / 100));
        let down = 0, balance = 0, monthly = 0;

        if (currentDeviceType === 'watch'){
          down = 0;
          balance = retail;
          monthly = ceil2(balance / TERM);
        } else {
          down = phoneDownPayment(retail);
          balance = retail - down;
          monthly = balance / TERM;
        }

        const devicePayFull = round2(retail + deviceTax);
        const deviceDueToday = round2(down + deviceTax);

        const payFullToday = addAccToFullChk.checked ? round2(devicePayFull + accessoriesDueToday) : devicePayFull;
        const dueToday = addAccToDueChk.checked ? round2(deviceDueToday + accessoriesDueToday) : deviceDueToday;

        text += `Device Summary\nType: ${currentDeviceType === 'watch' ? 'Watch' : 'Phone'}\nRetail: ${money(retail)}\nTax rate: ${taxRate.toFixed(2)}%\nDevice tax: ${money(deviceTax)}\nDown: ${money(down)}\nMonthly (device only): ${money(monthly)} x 24\nBalance (device only): ${money(balance)}\n\nAdd accessories to Due Today: ${addAccToDueChk.checked ? 'Yes' : 'No'}\nAdd accessories to Pay in Full: ${addAccToFullChk.checked ? 'Yes' : 'No'}\nPay in full today: ${money(payFullToday)}\nDue today: ${money(dueToday)}\n`;
      }

      try{
        await navigator.clipboard.writeText(text);
        copyBtn.textContent = "‚úì Copied!";
        setTimeout(() => copyBtn.textContent = "Copy Summary", 1400);
      }catch(e){
        prompt("Copy this summary:", text);
      }
    }

    // Events
    phoneBtn.addEventListener('click', (e) => { e.preventDefault(); setDeviceType('phone'); });
    watchBtn.addEventListener('click', (e) => { e.preventDefault(); setDeviceType('watch'); });
    calcBtn.addEventListener('click', (e) => { e.preventDefault(); calculate(true); });
    copyBtn.addEventListener('click', (e) => { e.preventDefault(); copySummary(); });
    resetBtn.addEventListener('click', (e) => { e.preventDefault(); resetAll(); });
    themeToggle.addEventListener('click', (e) => { e.preventDefault(); toggleTheme(); });

    // Auto-calc while typing
    [retailPriceInput, accEligibleInput, accNoDiscInput].forEach(el => {
      el.addEventListener('input', () => { sanitizeMoneyInput(el); scheduleAutoCalc(); });
      el.addEventListener('blur', () => calculate(false));
    });
    [taxRateInput, aarpUsaaChk, addAccToDueChk, addAccToFullChk].forEach(el => {
      el.addEventListener('input', scheduleAutoCalc);
      el.addEventListener('change', scheduleAutoCalc);
      el.addEventListener('blur', () => calculate(false));
    });

    window.addEventListener('load', () => {
      try{
        const savedTheme = localStorage.getItem('dpc_theme');
        if (savedTheme === 'dark') { document.body.classList.add('dark-mode'); themeToggle.textContent = '‚òÄÔ∏è'; }

        const savedTax = localStorage.getItem('dpc_taxRate');
        if (savedTax) taxRateInput.value = savedTax;

        const savedType = localStorage.getItem('dpc_deviceType');
        if (savedType === 'watch' || savedType === 'phone') setDeviceType(savedType);
      }catch(e){}
    });
  </script>
</body>
</html>
