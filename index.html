<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>Device Payment Calculator</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    
    :root {
      --bg-gradient-start: #ff6b35;
      --bg-gradient-end: #f7931e;
      --card-bg: #fff;
      --text-primary: #333;
      --text-secondary: #666;
      --text-inverse: #fff;
      --border-color: #e6e6e6;
      --border-active: #ff6b35;
      --btn-gradient-start: #ff6b35;
      --btn-gradient-end: #f7931e;
      --pill-bg: #fafafa;
      --error-bg: #fff1f1;
      --error-border: #f3b6b6;
      --error-text: #7a1111;
      --highlight-bg: rgba(255,107,53,.05);
      --highlight-bg-end: rgba(247,147,30,.05);
    }
    
    body.dark-mode {
      --bg-gradient-start: #1a1a2e;
      --bg-gradient-end: #16213e;
      --card-bg: #0f3460;
      --text-primary: #e9e9e9;
      --text-secondary: #b0b0b0;
      --text-inverse: #fff;
      --border-color: #2a4a6f;
      --border-active: #ff6b35;
      --btn-gradient-start: #ff6b35;
      --btn-gradient-end: #f7931e;
      --pill-bg: #1a3a5c;
      --error-bg: #3d1a1a;
      --error-border: #6b2b2b;
      --error-text: #ffb3b3;
      --highlight-bg: rgba(255,107,53,.15);
      --highlight-bg-end: rgba(247,147,30,.15);
    }
    
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:linear-gradient(135deg, var(--bg-gradient-start) 0%, var(--bg-gradient-end) 100%);
      min-height:100vh;
      padding:12px;
      -webkit-tap-highlight-color: transparent;
      transition: background 0.3s ease;
    }
    .container{ max-width:660px; margin:0 auto; }
    .header{ 
      text-align:center; 
      color: var(--text-inverse); 
      margin:6px 0 10px;
      position: relative;
    }
    .header h1{ font-size:22px; font-weight:900; text-shadow:0 2px 4px rgba(0,0,0,.12); }
    .header p{ font-size:12px; opacity:.92; margin-top:4px; }
    
    .theme-toggle{
      position: absolute;
      top: 0;
      right: 0;
      background: rgba(255,255,255,0.2);
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 20px;
      padding: 6px 12px;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.3s ease;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .theme-toggle:hover{
      background: rgba(255,255,255,0.3);
    }
    .theme-toggle:active{
      transform: scale(0.95);
    }

    .card{
      background: var(--card-bg);
      border-radius:16px;
      padding:14px;
      box-shadow:0 10px 34px rgba(0,0,0,.14);
      transition: background 0.3s ease;
    }

    .device-toggle{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
      margin-bottom:10px;
    }
    .toggle-btn{
      padding:12px 10px;
      border-radius:12px;
      border:2px solid var(--border-color);
      background: var(--card-bg);
      font-weight:900;
      font-size:14px;
      color: var(--text-secondary);
      cursor:pointer;
      transition: all 0.2s ease;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    .toggle-btn:active{
      transform: scale(0.98);
    }
    .toggle-btn.active{
      border-color: var(--border-active);
      background:linear-gradient(135deg, var(--btn-gradient-start) 0%, var(--btn-gradient-end) 100%);
      color: var(--text-inverse);
      box-shadow:0 2px 10px rgba(255,107,53,.28);
    }

    .grid2{ display:grid; grid-template-columns:1fr 1fr; gap:10px; }
    @media (max-width:520px){ .grid2{ grid-template-columns:1fr; } }

    .input-group{ margin-bottom:10px; }
    .label{
      display:block;
      font-size:11px;
      font-weight:900;
      letter-spacing:.6px;
      text-transform:uppercase;
      color: var(--text-primary);
      margin-bottom:6px;
    }
    .help{
      font-size:11px;
      color: var(--text-secondary);
      margin-top:6px;
      line-height:1.25;
    }

    .input-wrap{ position:relative; }
    .prefix{
      position:absolute;
      left:12px;
      top:50%;
      transform:translateY(-50%);
      font-weight:900;
      color: var(--border-active);
      pointer-events:none;
      z-index: 1;
    }
    input[type="number"]{
      width:100%;
      padding:12px 12px 12px 34px;
      font-size:16px;
      font-weight:900;
      border-radius:12px;
      border:2px solid var(--border-color);
      outline:none;
      background: var(--card-bg);
      color: var(--text-primary);
      -webkit-appearance: none;
      -moz-appearance: textfield;
      appearance: none;
      transition: all 0.2s ease;
    }
    input[type="number"]:focus{
      border-color: var(--border-active);
      box-shadow:0 0 0 4px rgba(255,107,53,.12);
    }
    input[type="number"]::placeholder {
      color: var(--text-secondary);
      opacity: 0.5;
    }
    
    input[type="number"]:focus::placeholder {
      opacity: 0.3;
    }

    input[type="number"]::-webkit-inner-spin-button,
    input[type="number"]::-webkit-outer-spin-button{ 
      -webkit-appearance:none; 
      margin:0; 
      display: none;
    }

    .pill{
      display:inline-block;
      padding:10px 12px;
      border-radius:12px;
      background: var(--pill-bg);
      border:2px solid var(--border-color);
      font-weight:900;
      font-size:14px;
      color: var(--text-primary);
      transition: all 0.3s ease;
    }

    .btnrow{
      display:flex;
      gap:8px;
      margin-top:2px;
      flex-wrap:wrap;
    }
    button{
      border:none;
      border-radius:12px;
      font-weight:900;
      cursor:pointer;
      transition:transform .1s, box-shadow .1s, opacity .1s;
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    button:active{ transform:translateY(1px); }

    .btn{
      flex: 1 1 160px;
      padding:14px;
      font-size:14px;
      letter-spacing:.6px;
      text-transform:uppercase;
      background:linear-gradient(135deg, var(--btn-gradient-start) 0%, var(--btn-gradient-end) 100%);
      color: var(--text-inverse);
      box-shadow:0 4px 14px rgba(255,107,53,.28);
      min-height: 48px;
    }
    .btn.secondary{
      background: var(--card-bg);
      color: var(--border-active);
      border:2px solid var(--border-active);
      box-shadow:none;
    }
    .btn.secondary:hover{ box-shadow:0 2px 12px rgba(255,107,53,.16); }

    .error{
      display:none;
      margin-top:10px;
      background: var(--error-bg);
      border:2px solid var(--error-border);
      color: var(--error-text);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      line-height:1.35;
      font-size:13px;
      transition: all 0.3s ease;
    }

    .results{ display:none; margin-top:12px; }
    .results.active{ 
      display:block; 
      animation: slideIn 0.3s ease-out;
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .calculating {
      pointer-events: none;
      opacity: 0.6;
    }

    .section-title{
      text-align:center;
      font-weight:900;
      color: var(--text-primary);
      font-size:13px;
      margin:10px 0 8px;
      letter-spacing:.4px;
    }

    .cards{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }
    .mini-card{
      border-radius:14px;
      border:2px solid var(--border-color);
      padding:10px;
      text-align:center;
      background: var(--card-bg);
      transition: all 0.3s ease;
    }
    .mini-card.highlight{
      border-color: var(--border-active);
      background:linear-gradient(135deg, var(--highlight-bg), var(--highlight-bg-end));
      box-shadow:0 4px 16px rgba(255, 107, 53, 0.10);
    }
    .mini-title{
      font-size:11px;
      font-weight:900;
      color: var(--border-active);
      text-transform:uppercase;
      letter-spacing:.8px;
      margin-bottom:6px;
    }
    .mini-value{
      font-size:22px;
      font-weight:900;
      color: var(--text-primary);
      margin-bottom:2px;
    }
    .mini-sub{
      font-size:10px;
      color: var(--text-secondary);
      text-transform:uppercase;
      letter-spacing:.6px;
    }

    .note{
      display:none;
      margin-top:8px;
      text-align:center;
      font-size:12px;
      color: var(--text-primary);
      line-height:1.35;
    }
    .note b{ font-weight:900; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <button class="theme-toggle" id="themeToggle" type="button" aria-label="Toggle theme">üåô</button>
      <h1>Device Payment Calculator</h1>
      <p>Auto-calculates down payment (phones) and monthly payments. Tax rate is manual.</p>
    </div>

    <div class="card">
      <div class="device-toggle" role="tablist" aria-label="Device type">
        <button class="toggle-btn active" id="phoneBtn" type="button">üì± Phone</button>
        <button class="toggle-btn" id="watchBtn" type="button">‚åö Watch</button>
      </div>

      <div class="input-group">
        <label class="label" for="retailPrice">Retail Price</label>
        <div class="input-wrap">
          <span class="prefix" aria-hidden="true">$</span>
          <input 
            type="number" 
            id="retailPrice" 
            placeholder="0" 
            step="0.01" 
            min="0" 
            inputmode="decimal"
            aria-label="Retail price in dollars"
            aria-describedby="retailHelp"
          />
        </div>
        <div class="help" id="retailHelp">Tip: For phones, retail is rounded to a whole dollar.</div>
      </div>

      <div class="grid2">
        <div class="input-group">
          <label class="label" for="taxRate">Tax Rate (%)</label>
          <div class="input-wrap">
            <span class="prefix" aria-hidden="true">%</span>
            <input 
              type="number" 
              id="taxRate" 
              value="8.9" 
              step="0.01" 
              min="0" 
              max="100" 
              inputmode="decimal"
              aria-label="Tax rate percentage"
              aria-describedby="taxHelp"
            />
          </div>
          <div class="help" id="taxHelp">Enter your local tax rate (example: <b>8.9</b>).</div>
        </div>

        <div class="input-group">
          <label class="label">Term</label>
          <div class="pill">24 months</div>
          <div class="help">Fixed term.</div>
        </div>
      </div>

      <div class="btnrow">
        <button class="btn" type="button" id="calcBtn">Calculate</button>
        <button class="btn secondary" id="copyBtn" type="button">Copy Summary</button>
        <button class="btn secondary" type="button" id="resetBtn">Reset</button>
      </div>

      <div class="error" id="errorBox"></div>

      <div class="results" id="results">
        <div class="section-title">At a Glance</div>

        <div class="cards">
          <div class="mini-card">
            <div class="mini-title">Pay in Full Today</div>
            <div class="mini-value" id="payFullToday">$0.00</div>
            <div class="mini-sub">Retail + tax</div>
          </div>

          <div class="mini-card highlight">
            <div class="mini-title">Due Today</div>
            <div class="mini-value" id="dueToday">$0.00</div>
            <div class="mini-sub">Down + tax</div>
          </div>
        </div>

        <div class="cards" style="margin-bottom:6px;">
          <div class="mini-card">
            <div class="mini-title">Monthly Payment</div>
            <div class="mini-value" id="infoMonthly">$0.00</div>
            <div class="mini-sub">x 24 months</div>
          </div>
          <div class="mini-card">
            <div class="mini-title">Remaining Balance</div>
            <div class="mini-value" id="infoBalance">$0.00</div>
            <div class="mini-sub">After down</div>
          </div>
          <div class="mini-card">
            <div class="mini-title">Down Payment</div>
            <div class="mini-value" id="infoDown">$0.00</div>
            <div class="mini-sub" id="downSub">Auto</div>
          </div>
          <div class="mini-card">
            <div class="mini-title">Sales Tax</div>
            <div class="mini-value" id="infoTax">$0.00</div>
            <div class="mini-sub">On retail</div>
          </div>
        </div>

        <div class="note" id="roundingNote"></div>
      </div>
    </div>
  </div>

  <script>
    const TERM = 24;
    let currentDeviceType = 'phone';

    const retailPriceInput = document.getElementById('retailPrice');
    const taxRateInput = document.getElementById('taxRate');
    const results = document.getElementById('results');
    const errorBox = document.getElementById('errorBox');
    const roundingNoteDiv = document.getElementById('roundingNote');
    const retailHelp = document.getElementById('retailHelp');
    const copyBtn = document.getElementById('copyBtn');
    const phoneBtn = document.getElementById('phoneBtn');
    const watchBtn = document.getElementById('watchBtn');
    const calcBtn = document.getElementById('calcBtn');
    const resetBtn = document.getElementById('resetBtn');
    const themeToggle = document.getElementById('themeToggle');

    function money(n){
      if (isNaN(n) || !isFinite(n)) return '$0.00';
      return n.toLocaleString('en-US', { 
        style:'currency', 
        currency:'USD',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }
    function round2(n){ 
      if (isNaN(n)) return 0;
      return Math.round((n + Number.EPSILON) * 100) / 100; 
    }
    function ceil2(n){ 
      if (isNaN(n)) return 0;
      return Math.ceil(n * 100) / 100; 
    }

    function showError(msg){
      errorBox.style.display='block';
      errorBox.textContent=msg;
    }
    function clearError(){
      errorBox.style.display='none';
      errorBox.textContent='';
    }

    function toggleTheme(){
      const isDark = document.body.classList.toggle('dark-mode');
      themeToggle.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
      try {
        localStorage.setItem('dpc_theme', isDark ? 'dark' : 'light');
      } catch(e){}
    }

    // Phone rule: Down = (Retail mod 24); if Down < 11 then Down += 24
    function phoneDownPayment(retailWhole){
      let down = ((retailWhole % TERM) + TERM) % TERM;
      if (down < 11) down += TERM;
      return down;
    }

    function setDeviceType(type){
      currentDeviceType = type;
      phoneBtn.classList.toggle('active', type === 'phone');
      watchBtn.classList.toggle('active', type === 'watch');

      retailHelp.textContent = (type === 'phone')
        ? "Tip: For phones, retail is rounded to a whole dollar."
        : "Tip: Watches can include cents. Monthly is rounded up to the nearest cent.";

      try { localStorage.setItem('dpc_deviceType', type); } catch(e){}

      // Clear results when switching device type
      results.classList.remove('active');
      clearError();
    }

    function calculate(userInitiated = false){
      clearError();
      roundingNoteDiv.style.display = 'none';
      roundingNoteDiv.textContent = '';
      if (userInitiated) {
        copyBtn.textContent = "Copy Summary";
      }

      // Get and sanitize inputs
      const retailInput = retailPriceInput.value.trim();
      const taxInput = taxRateInput.value.trim();

      // Better input validation
      if (!retailInput || retailInput === '' || retailInput === '0') {
        if (userInitiated) {
          showError('Please enter a retail price.');
          retailPriceInput.focus();
        }
        results.classList.remove('active');
        return;
      }

      let retail = parseFloat(retailInput);
      const taxRate = parseFloat(taxInput || '0');

      if (isNaN(retail) || retail <= 0) {
        showError('Please enter a valid retail price greater than $0.');
        results.classList.remove('active');
        retailPriceInput.focus();
        return;
      }

      if (isNaN(taxRate) || !isFinite(taxRate) || taxRate < 0 || taxRate > 100){
        showError('Tax rate must be between 0% and 100%.');
        results.classList.remove('active');
        taxRateInput.focus();
        return;
      }

      try { localStorage.setItem('dpc_taxRate', taxRate.toFixed(2)); } catch(e){}

      // Only round and update the input value if user explicitly calculated or on blur
      // This prevents interference while typing
      if (userInitiated){
        if (currentDeviceType === 'phone'){
          retail = Math.round(retail);
          retailPriceInput.value = retail.toString();
        } else {
          retail = round2(retail);
          retailPriceInput.value = retail.toFixed(2);
        }
      }

      const tax = round2(retail * (taxRate / 100));
      const payFullToday = round2(retail + tax);

      let down = 0, balance = 0, monthlyDisplay = 0;

      if (currentDeviceType === 'watch'){
        down = 0;
        balance = retail;

        // Watch monthly: round UP to the next cent to match typical display.
        monthlyDisplay = ceil2(balance / TERM);

        const monthlyTotalShown = round2(monthlyDisplay * TERM);
        const diff = round2(monthlyTotalShown - retail);
        if (diff >= 0.01){
          roundingNoteDiv.style.display = 'block';
          roundingNoteDiv.innerHTML =
            `Monthly is rounded up to the nearest cent. The last payment is adjusted by <b>${money(diff)}</b> so the total matches retail.`;
        }
        document.getElementById('downSub').textContent = "0";
      } else {
        down = phoneDownPayment(retail);
        if (down > retail){
          showError('Retail price is too small for the down-payment rule.');
          results.classList.remove('active');
          return;
        }
        balance = retail - down;
        monthlyDisplay = balance / TERM;
        document.getElementById('downSub').textContent = "Auto";
      }

      const dueToday = round2(down + tax);

      document.getElementById('payFullToday').textContent = money(payFullToday);
      document.getElementById('dueToday').textContent = money(dueToday);

      document.getElementById('infoMonthly').textContent = money(monthlyDisplay);
      document.getElementById('infoBalance').textContent = money(balance);
      document.getElementById('infoDown').textContent = money(down);
      document.getElementById('infoTax').textContent = money(tax);

      results.classList.add('active');
    }

    function resetAll(){
      retailPriceInput.value = "";
      try {
        const savedTax = localStorage.getItem('dpc_taxRate');
        taxRateInput.value = savedTax ? savedTax : "8.90";
      } catch(e){
        taxRateInput.value = "8.90";
      }
      setDeviceType('phone');
      results.classList.remove('active');
      clearError();
      roundingNoteDiv.style.display = 'none';
      copyBtn.textContent = "Copy Summary";
      copyBtn.style.background = '';
      
      // Focus retail price for next calculation
      setTimeout(() => {
        retailPriceInput.focus();
      }, 100);
    }

    async function copySummary(){
      // Recalculate to ensure we have current values
      calculate(true);

      let retail = parseFloat(retailPriceInput.value || '0');
      const taxRate = parseFloat(taxRateInput.value || '0');
      if (!retail || retail <= 0) {
        showError('Please enter a retail price to copy summary.');
        return;
      }

      if (currentDeviceType === 'phone') retail = Math.round(retail);
      else retail = round2(retail);

      const tax = round2(retail * (taxRate / 100));
      const payFullToday = round2(retail + tax);

      let down = 0, balance = 0, monthly = 0;
      if (currentDeviceType === 'watch'){
        down = 0;
        balance = retail;
        monthly = ceil2(balance / TERM);
      } else {
        down = phoneDownPayment(retail);
        balance = retail - down;
        monthly = balance / TERM;
      }

      const dueToday = round2(down + tax);

      const text =
`Device Payment Summary
Type: ${currentDeviceType === 'watch' ? 'Watch' : 'Phone'}
Retail: ${money(retail)}
Tax rate: ${taxRate.toFixed(2)}%
Sales tax: ${money(tax)}
Pay in full today: ${money(payFullToday)}

Monthly payment: ${money(monthly)} x 24
Remaining balance: ${money(balance)}
Down payment: ${money(down)}
Due today (down + tax): ${money(dueToday)}`;

      try{
        await navigator.clipboard.writeText(text);
        const originalText = copyBtn.textContent;
        copyBtn.textContent = "‚úì Copied!";
        copyBtn.style.background = 'linear-gradient(135deg, #22c55e 0%, #16a34a 100%)';
        setTimeout(() => {
          copyBtn.textContent = originalText;
          copyBtn.style.background = '';
        }, 2000);
      }catch(e){
        // Fallback for older browsers or when clipboard API fails
        const textArea = document.createElement('textarea');
        textArea.value = text;
        textArea.style.position = 'fixed';
        textArea.style.left = '-9999px';
        document.body.appendChild(textArea);
        textArea.select();
        try {
          document.execCommand('copy');
          const originalText = copyBtn.textContent;
          copyBtn.textContent = "‚úì Copied!";
          setTimeout(() => copyBtn.textContent = originalText, 2000);
        } catch(err) {
          showError('Copy failed. Please try again or use a different browser.');
        }
        document.body.removeChild(textArea);
      }
    }

    // Event listeners using direct references instead of inline handlers
    phoneBtn.addEventListener('click', (e) => {
      e.preventDefault();
      setDeviceType('phone');
    });

    watchBtn.addEventListener('click', (e) => {
      e.preventDefault();
      setDeviceType('watch');
    });

    calcBtn.addEventListener('click', (e) => {
      e.preventDefault();
      calculate(true);
    });

    copyBtn.addEventListener('click', (e) => {
      e.preventDefault();
      copySummary();
    });

    resetBtn.addEventListener('click', (e) => {
      e.preventDefault();
      resetAll();
    });

    themeToggle.addEventListener('click', (e) => {
      e.preventDefault();
      toggleTheme();
    });

    // Calculate when user finishes typing (leaves the field or presses Enter)
    retailPriceInput.addEventListener('blur', () => {
      const rawValue = retailPriceInput.value.trim();
      if (!rawValue || rawValue === '') return;
      
      let retail = parseFloat(rawValue);
      
      if (isNaN(retail) || retail <= 0) {
        showError('Please enter a valid retail price.');
        return;
      }
      
      if (currentDeviceType === 'phone'){
        retail = Math.round(retail);
        retailPriceInput.value = retail.toString();
      } else {
        retail = round2(retail);
        retailPriceInput.value = retail.toFixed(2);
      }
      calculate(false);
    });

    taxRateInput.addEventListener('blur', () => {
      const rawValue = taxRateInput.value.trim();
      if (!rawValue || rawValue === '') {
        taxRateInput.value = '8.90';
        return;
      }
      
      const taxRate = parseFloat(rawValue);
      
      if (isNaN(taxRate) || taxRate < 0 || taxRate > 100) {
        showError('Tax rate must be between 0% and 100%.');
        taxRateInput.value = '8.90';
        return;
      }
      
      taxRateInput.value = taxRate.toFixed(2);
      if (retailPriceInput.value.trim()) {
        calculate(false);
      }
    });

    // Handle Enter key for better navigation
    retailPriceInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter'){ 
        e.preventDefault(); 
        retailPriceInput.blur();
        taxRateInput.focus();
      }
    });

    taxRateInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter'){ 
        e.preventDefault(); 
        taxRateInput.blur();
        calculate(true);
      }
    });

    // Prevent form submission if wrapped in a form
    document.addEventListener('submit', (e) => {
      e.preventDefault();
      return false;
    });

    // Initialize on load
    window.addEventListener('load', () => {
      try{
        // Load saved theme
        const savedTheme = localStorage.getItem('dpc_theme');
        if (savedTheme === 'dark') {
          document.body.classList.add('dark-mode');
          themeToggle.textContent = '‚òÄÔ∏è';
        }

        const savedTax = localStorage.getItem('dpc_taxRate');
        if (savedTax) taxRateInput.value = savedTax;

        const savedType = localStorage.getItem('dpc_deviceType');
        if (savedType === 'watch' || savedType === 'phone') setDeviceType(savedType);
      }catch(e){}

      // Don't auto-focus on mobile to prevent unwanted keyboard popup
      // Users can tap the field when ready
    });
  </script>
</body>
</html>
