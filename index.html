<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
  <title>Device Payment Calculator</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background:linear-gradient(135deg,#ff6b35 0%,#f7931e 100%);
      min-height:100vh;
      padding:16px;
      -webkit-tap-highlight-color:transparent;
    }
    .wrap{ max-width:980px; margin:0 auto; }
    .top{
      text-align:center;
      color:#fff;
      margin:8px 0 14px;
      position:relative;
    }
    .top h1{ font-size:28px; font-weight:900; text-shadow:0 2px 4px rgba(0,0,0,.15); }
    .top p{ font-size:13px; opacity:.92; margin-top:6px; }
    .moon{
      position:absolute; right:0; top:0;
      width:44px; height:44px;
      border-radius:999px;
      border:2px solid rgba(255,255,255,.35);
      background:rgba(255,255,255,.15);
      color:#fff;
      cursor:pointer;
      font-size:18px;
    }

    .card{
      background:#fff;
      border-radius:18px;
      padding:18px;
      box-shadow:0 10px 35px rgba(0,0,0,.15);
    }

    .tabs{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-bottom:14px;
    }
    .tab{
      border:2px solid #e6e6e6;
      background:#fff;
      border-radius:12px;
      padding:12px;
      font-weight:900;
      cursor:pointer;
    }
    .tab.active{
      border-color:#ff6b35;
      background:linear-gradient(135deg,#ff6b35 0%,#f7931e 100%);
      color:#fff;
    }

    .label{
      font-size:12px;
      font-weight:900;
      color:#333;
      letter-spacing:.6px;
      text-transform:uppercase;
      margin:10px 0 6px;
    }
    .help{
      font-size:12px;
      color:#666;
      margin-top:6px;
      line-height:1.3;
    }

    .row2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    @media (max-width:760px){ .row2{ grid-template-columns:1fr; } }

    .inwrap{ position:relative; }
    .prefix{
      position:absolute; left:12px; top:50%;
      transform:translateY(-50%);
      font-weight:900;
      color:#ff6b35;
      pointer-events:none;
    }

    input[type="text"], input[type="number"]{
      width:100%;
      padding:12px 12px 12px 34px;
      font-size:16px; /* avoids iOS zoom */
      border:2px solid #e6e6e6;
      border-radius:12px;
      outline:none;
      font-weight:900;
    }
    input:focus{ border-color:#ff6b35; box-shadow:0 0 0 4px rgba(255,107,53,.12); }

    .pill{
      display:inline-block;
      padding:10px 12px;
      border-radius:12px;
      border:2px solid #e6e6e6;
      background:#fafafa;
      font-weight:900;
      color:#333;
      min-height:46px;
      line-height:24px;
    }

    .btnrow{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
      margin-top:14px;
    }
    @media (max-width:760px){ .btnrow{ grid-template-columns:1fr; } }

    .btn{
      min-height:48px;
      border-radius:12px;
      border:2px solid #ff6b35;
      font-weight:900;
      letter-spacing:.8px;
      text-transform:uppercase;
      cursor:pointer;
    }
    .btn.primary{
      border:none;
      background:linear-gradient(135deg,#ff6b35 0%,#f7931e 100%);
      color:#fff;
    }
    .btn.ghost{
      background:#fff;
      color:#ff6b35;
    }

    .error{
      margin-top:12px;
      display:none;
      background:#fff1f1;
      border:2px solid #f3b6b6;
      color:#7a1111;
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
    }

    .quoteHead{
      margin-top:16px;
      text-align:center;
      font-weight:900;
      color:#333;
    }

    .quoteCards{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width:760px){ .quoteCards{ grid-template-columns:1fr; } }

    .qcard{
      border:2px solid #e6e6e6;
      border-radius:14px;
      padding:14px;
      text-align:center;
      background:#fff;
    }
    .qcard.hi{
      border-color:#ff6b35;
      background:rgba(255,107,53,.05);
    }
    .qtitle{
      font-size:12px;
      font-weight:900;
      letter-spacing:.8px;
      text-transform:uppercase;
      color:#ff6b35;
    }
    .qval{
      font-size:34px;
      font-weight:900;
      color:#222;
      margin-top:6px;
    }
    .qsub{
      font-size:11px;
      color:#666;
      margin-top:4px;
      letter-spacing:.6px;
      text-transform:uppercase;
    }

    /* Breakdown tables */
    .breakBox{
      margin-top:14px;
      border:2px solid #e6e6e6;
      border-radius:14px;
      padding:12px;
      background:#fff;
    }
    .breakTitle{
      font-weight:900;
      color:#ff6b35;
      text-transform:uppercase;
      letter-spacing:.8px;
      font-size:12px;
      margin-bottom:8px;
    }
    .line{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:6px 0;
      border-bottom:1px solid #eee;
      font-size:14px;
      color:#333;
      font-weight:700;
    }
    .line:last-child{ border-bottom:none; }
    .line strong{ font-weight:900; }
    .line.total{
      padding-top:10px;
      border-top:2px solid #eee;
      border-bottom:none;
      color:#ff6b35;
      font-size:16px;
    }

    /* Accessory combine box */
    .combineRow{
      margin-top:14px;
      display:flex;
      gap:10px;
      align-items:center;
      font-weight:900;
      color:#333;
    }

    .devicePanel{
      margin-top:10px;
      border:2px solid #16a34a;
      border-radius:14px;
      padding:12px;
      background:#f0fff7;
    }
    .devicePanel .panelTitle{
      font-weight:900;
      letter-spacing:.8px;
      text-transform:uppercase;
      color:#16a34a;
      font-size:12px;
      margin-bottom:10px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    .smallTabs{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-bottom:10px;
    }
    .smallTab{
      border:2px solid #e6e6e6;
      border-radius:12px;
      background:#fff;
      padding:10px;
      font-weight:900;
      cursor:pointer;
    }
    .smallTab.active{
      border-color:#16a34a;
      background:#16a34a;
      color:#fff;
    }

    .checkline{
      display:flex;
      flex-wrap:wrap;
      gap:16px;
      margin-top:10px;
      font-weight:900;
      color:#333;
      align-items:center;
    }
    .checkline label{ display:flex; gap:8px; align-items:center; font-size:13px; }

  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <button class="moon" id="themeBtn" type="button" title="Toggle theme">üåô</button>
      <h1>Device Payment Calculator</h1>
      <p>Accessories are separate (not financed). You can optionally add accessory totals into device ‚ÄúDue Today‚Äù or ‚ÄúPay in Full.‚Äù</p>
    </div>

    <div class="card">

      <!-- ACCESSORIES SECTION (your screenshot flow) -->
      <div class="row2">
        <div>
          <div class="label">Eligible Accessories Subtotal</div>
          <div class="inwrap">
            <span class="prefix">$</span>
            <input id="accEligible" type="text" inputmode="decimal" placeholder="0" />
          </div>
          <div class="help">Cases, chargers (non-Apple), screen protectors, etc. Gets 30% off if AARP/USAA is checked.</div>
        </div>

        <div>
          <div class="label">No-Discount Subtotal (Apple/Audio)</div>
          <div class="inwrap">
            <span class="prefix">$</span>
            <input id="accNoDisc" type="text" inputmode="decimal" placeholder="0" />
          </div>
          <div class="help">Apple products and audio accessories (no discount applied).</div>
        </div>
      </div>

      <div class="combineRow">
        <label style="display:flex; gap:10px; align-items:center;">
          <input type="checkbox" id="aarpUsaa" />
          AARP/USAA Member (30% off eligible accessories)
        </label>
      </div>

      <div class="label">Tax Rate (%)</div>
      <div class="inwrap">
        <span class="prefix">%</span>
        <input id="taxRate" type="number" inputmode="decimal" step="0.01" value="8.9" />
      </div>
      <div class="help">Your local sales tax rate (example: 8.9).</div>

      <div class="combineRow">
        <label style="display:flex; gap:10px; align-items:center;">
          <input type="checkbox" id="combineDevice" />
          Combine with device purchase
        </label>
      </div>

      <!-- DEVICE DETAILS PANEL -->
      <div class="devicePanel" id="devicePanel" style="display:none;">
        <div class="panelTitle">üì± Device Details</div>

        <div class="smallTabs">
          <button class="smallTab active" id="devPhoneBtn" type="button">üì± Phone</button>
          <button class="smallTab" id="devWatchBtn" type="button">‚åö Watch</button>
        </div>

        <div class="label">Device Retail Price</div>
        <div class="inwrap">
          <span class="prefix">$</span>
          <input id="deviceRetail" type="text" inputmode="decimal" placeholder="0" />
        </div>
        <div class="help" id="deviceHint">Retail is rounded to a whole dollar for phones.</div>

        <div class="checkline">
          <label><input type="checkbox" id="addAccToDue" /> Add accessories to <b>Due Today</b></label>
          <label><input type="checkbox" id="addAccToFull" /> Add accessories to <b>Pay in Full</b></label>
        </div>
      </div>

      <div class="btnrow">
        <button class="btn primary" id="calcBtn" type="button">Calculate</button>
        <button class="btn ghost" id="copyBtn" type="button">Copy Summary</button>
        <button class="btn ghost" id="resetBtn" type="button">Reset</button>
      </div>

      <div class="error" id="errBox"></div>

      <div class="quoteHead" id="quoteTitle" style="display:none;">Accessory Quote</div>

      <div class="quoteCards" id="quoteCards" style="display:none;">
        <div class="qcard">
          <div class="qtitle" id="leftTitle">Accessory Total Today</div>
          <div class="qval" id="leftVal">$0.00</div>
          <div class="qsub" id="leftSub">Accessories + tax</div>
        </div>
        <div class="qcard hi">
          <div class="qtitle" id="rightTitle">Accessory Due Today</div>
          <div class="qval" id="rightVal">$0.00</div>
          <div class="qsub" id="rightSub">Accessories + tax</div>
        </div>
      </div>

      <!-- ACCESSORY BREAKDOWN -->
      <div class="breakBox" id="accBreak" style="display:none;">
        <div class="breakTitle">Accessory Breakdown</div>

        <div class="line"><span>Eligible Subtotal:</span><strong id="bElig">$0.00</strong></div>
        <div class="line"><span>AARP/USAA Discount (30%):</span><strong id="bDisc">$0.00</strong></div>
        <div class="line"><span>Eligible After Discount:</span><strong id="bEligAfter">$0.00</strong></div>
        <div class="line"><span>No-Discount Subtotal:</span><strong id="bNoDisc">$0.00</strong></div>

        <div class="line" style="margin-top:6px;"><span>Accessories Subtotal:</span><strong id="bAccSub">$0.00</strong></div>
        <div class="line"><span>Accessory Tax:</span><strong id="bAccTax">$0.00</strong></div>

        <div class="line total"><span>Total Due Today:</span><strong id="bAccTotal">$0.00</strong></div>
      </div>

      <!-- DEVICE BREAKDOWN (NEW: matches accessory breakdown style) -->
      <div class="breakBox" id="devBreak" style="display:none;">
        <div class="breakTitle">Device Breakdown</div>

        <div class="line"><span>Device Retail:</span><strong id="dRetail">$0.00</strong></div>
        <div class="line"><span>Down Payment:</span><strong id="dDown">$0.00</strong></div>
        <div class="line"><span>Remaining Balance:</span><strong id="dBal">$0.00</strong></div>
        <div class="line"><span>Monthly Payment (device only):</span><strong id="dMonthly">$0.00</strong></div>
        <div class="line"><span>Device Tax:</span><strong id="dTax">$0.00</strong></div>

        <div class="line" style="margin-top:6px;"><span>Device Due Today:</span><strong id="dDue">$0.00</strong></div>
        <div class="line"><span>Device Pay in Full:</span><strong id="dFull">$0.00</strong></div>

        <div class="line" id="dCombinedRow1" style="display:none;"><span>Combined Due Today:</span><strong id="dDueCombined">$0.00</strong></div>
        <div class="line" id="dCombinedRow2" style="display:none;"><span>Combined Pay in Full:</span><strong id="dFullCombined">$0.00</strong></div>

        <div class="line total" id="dNote" style="display:none;"><span>Note:</span><strong id="dNoteText" style="color:#666; font-size:13px; font-weight:800;"></strong></div>
      </div>

    </div>
  </div>

  <script>
    const TERM = 24;
    const DISCOUNT = 0.30;

    const el = (id)=>document.getElementById(id);

    // inputs
    const accEligible = el('accEligible');
    const accNoDisc   = el('accNoDisc');
    const aarpUsaa    = el('aarpUsaa');
    const taxRate     = el('taxRate');

    const combineDevice = el('combineDevice');
    const devicePanel   = el('devicePanel');
    const deviceRetail  = el('deviceRetail');
    const addAccToDue   = el('addAccToDue');
    const addAccToFull  = el('addAccToFull');

    const devPhoneBtn = el('devPhoneBtn');
    const devWatchBtn = el('devWatchBtn');
    const deviceHint  = el('deviceHint');

    const errBox = el('errBox');

    // outputs
    const quoteTitle = el('quoteTitle');
    const quoteCards = el('quoteCards');
    const leftTitle = el('leftTitle');
    const rightTitle = el('rightTitle');
    const leftVal = el('leftVal');
    const rightVal = el('rightVal');
    const leftSub = el('leftSub');
    const rightSub = el('rightSub');

    const accBreak = el('accBreak');
    const devBreak = el('devBreak');

    let deviceType = 'phone'; // phone | watch
    let typingTimer = null;

    function money(n){
      if (!isFinite(n)) n = 0;
      return n.toLocaleString('en-US',{style:'currency',currency:'USD',minimumFractionDigits:2,maximumFractionDigits:2});
    }
    function round2(n){ return Math.round((n + Number.EPSILON) * 100) / 100; }
    function ceil2(n){ return Math.ceil(n * 100) / 100; }

    function showError(msg){
      errBox.style.display='block';
      errBox.textContent = msg;
    }
    function clearError(){
      errBox.style.display='none';
      errBox.textContent = '';
    }

    // strict numeric sanitizer (prevents letters)
    function sanitizeMoneyInput(input){
      const raw = input.value;
      let cleaned = raw.replace(/[^0-9.]/g,'');
      const firstDot = cleaned.indexOf('.');
      if (firstDot !== -1){
        cleaned = cleaned.slice(0, firstDot+1) + cleaned.slice(firstDot+1).replace(/\./g,'');
      }
      if (cleaned !== raw){
        const pos = input.selectionStart || cleaned.length;
        input.value = cleaned;
        try{ input.setSelectionRange(pos, pos); }catch(e){}
      }
    }
    function parseMoney(input){
      const v = (input.value||'').trim();
      const n = parseFloat(v);
      return isFinite(n) ? n : 0;
    }

    // phone down rule (remainder, min 11)
    function phoneDown(retailWhole){
      let down = ((retailWhole % TERM) + TERM) % TERM;
      if (down < 11) down += TERM;
      return down;
    }

    function scheduleCalc(){
      if (typingTimer) clearTimeout(typingTimer);
      typingTimer = setTimeout(()=>calculate(false), 250);
    }

    function setDeviceType(t){
      deviceType = t;
      devPhoneBtn.classList.toggle('active', t==='phone');
      devWatchBtn.classList.toggle('active', t==='watch');
      deviceHint.textContent = t==='phone'
        ? 'Retail is rounded to a whole dollar for phones.'
        : 'Watches can include cents. Monthly is rounded up to the nearest cent.';
      scheduleCalc();
    }

    combineDevice.addEventListener('change', ()=>{
      devicePanel.style.display = combineDevice.checked ? 'block' : 'none';
      if (!combineDevice.checked){
        devBreak.style.display = 'none';
      }
      scheduleCalc();
    });

    devPhoneBtn.addEventListener('click', ()=>setDeviceType('phone'));
    devWatchBtn.addEventListener('click', ()=>setDeviceType('watch'));

    // input listeners
    [accEligible, accNoDisc, deviceRetail].forEach(inp=>{
      inp.addEventListener('input', ()=>{
        sanitizeMoneyInput(inp);
        scheduleCalc();
      });
    });
    [taxRate].forEach(inp=>{
      inp.addEventListener('input', scheduleCalc);
      inp.addEventListener('blur', scheduleCalc);
    });
    [aarpUsaa, addAccToDue, addAccToFull].forEach(chk=>{
      chk.addEventListener('change', scheduleCalc);
    });

    el('calcBtn').addEventListener('click', ()=>calculate(true));
    el('resetBtn').addEventListener('click', ()=>{
      accEligible.value=''; accNoDisc.value='';
      aarpUsaa.checked=false;
      taxRate.value='8.9';
      combineDevice.checked=false;
      devicePanel.style.display='none';
      deviceRetail.value='';
      addAccToDue.checked=false;
      addAccToFull.checked=false;
      setDeviceType('phone');
      accBreak.style.display='none';
      devBreak.style.display='none';
      quoteTitle.style.display='none';
      quoteCards.style.display='none';
      clearError();
    });

    el('copyBtn').addEventListener('click', ()=>{
      // quick copy: just reuse the visible breakdown values (safe + simple)
      const lines = [];
      if (accBreak.style.display!=='none'){
        lines.push('Accessory Breakdown');
        lines.push(`Eligible: ${el('bElig').textContent}`);
        lines.push(`Discount: ${el('bDisc').textContent}`);
        lines.push(`Eligible After: ${el('bEligAfter').textContent}`);
        lines.push(`No-Discount: ${el('bNoDisc').textContent}`);
        lines.push(`Accessories Subtotal: ${el('bAccSub').textContent}`);
        lines.push(`Accessory Tax: ${el('bAccTax').textContent}`);
        lines.push(`Accessory Due Today: ${el('bAccTotal').textContent}`);
        lines.push('');
      }
      if (devBreak.style.display!=='none'){
        lines.push('Device Breakdown');
        lines.push(`Retail: ${el('dRetail').textContent}`);
        lines.push(`Down: ${el('dDown').textContent}`);
        lines.push(`Balance: ${el('dBal').textContent}`);
        lines.push(`Monthly: ${el('dMonthly').textContent}`);
        lines.push(`Device Tax: ${el('dTax').textContent}`);
        lines.push(`Device Due Today: ${el('dDue').textContent}`);
        lines.push(`Device Pay in Full: ${el('dFull').textContent}`);
        if (el('dCombinedRow1').style.display!=='none') lines.push(`Combined Due Today: ${el('dDueCombined').textContent}`);
        if (el('dCombinedRow2').style.display!=='none') lines.push(`Combined Pay in Full: ${el('dFullCombined').textContent}`);
      }
      const text = lines.join('\n').trim();
      navigator.clipboard.writeText(text).then(()=>{
        el('copyBtn').textContent='Copied!';
        setTimeout(()=>el('copyBtn').textContent='Copy Summary', 1000);
      }).catch(()=>{});
    });

    function calculate(userInitiated){
      clearError();

      const t = parseFloat(taxRate.value||'0');
      if (!isFinite(t) || t<0 || t>100){
        showError('Tax rate must be between 0% and 100%.');
        return;
      }

      // accessories
      const elig = round2(parseMoney(accEligible));
      const nod  = round2(parseMoney(accNoDisc));
      const discount = (aarpUsaa.checked && elig>0) ? round2(elig*DISCOUNT) : 0;
      const eligAfter = round2(elig - discount);
      const accSub = round2(eligAfter + nod);
      const accTax = round2(accSub * (t/100));
      const accDue = round2(accSub + accTax);

      // show accessory quote even if device not entered
      if (elig>0 || nod>0){
        quoteTitle.style.display='block';
        quoteTitle.textContent = 'Accessory Quote';
        quoteCards.style.display='grid';

        leftTitle.textContent = 'Accessory Total Today';
        rightTitle.textContent = 'Accessory Due Today';
        leftVal.textContent = money(accDue);
        rightVal.textContent = money(accDue);
        leftSub.textContent = 'Accessories + tax';
        rightSub.textContent = 'Accessories + tax';

        // accessory breakdown
        accBreak.style.display='block';
        el('bElig').textContent = money(elig);
        el('bDisc').textContent = money(discount);
        el('bEligAfter').textContent = money(eligAfter);
        el('bNoDisc').textContent = money(nod);
        el('bAccSub').textContent = money(accSub);
        el('bAccTax').textContent = money(accTax);
        el('bAccTotal').textContent = money(accDue);
      } else {
        // hide accessory outputs if nothing entered
        accBreak.style.display='none';
      }

      // device section only if combine checked + device price entered
      if (!combineDevice.checked){
        devBreak.style.display='none';
        return;
      }

      const rRaw = round2(parseMoney(deviceRetail));
      if (rRaw <= 0){
        // combine checked but no device: still allow accessory-only
        devBreak.style.display='none';
        return;
      }

      let retail = rRaw;
      let down=0, monthly=0, balance=0, noteText='';

      if (deviceType === 'phone'){
        retail = Math.round(retail);
        if (userInitiated) deviceRetail.value = retail.toString();
        down = phoneDown(retail);
        balance = retail - down;
        monthly = balance / TERM;
      } else {
        retail = round2(retail);
        if (userInitiated) deviceRetail.value = retail.toFixed(2);
        down = 0;
        balance = retail;
        monthly = ceil2(balance / TERM);

        const shown = round2(monthly * TERM);
        const diff = round2(shown - retail);
        if (diff >= 0.01){
          noteText = `Monthly rounds up to the nearest cent. Last payment adjusts by ${money(diff)} to match retail.`;
        }
      }

      const devTax = round2(retail * (t/100));
      const devDue = round2(down + devTax);
      const devFull = round2(retail + devTax);

      // combined if checkboxes checked and accessories exist
      const combinedDue = addAccToDue.checked ? round2(devDue + accDue) : devDue;
      const combinedFull = addAccToFull.checked ? round2(devFull + accDue) : devFull;

      devBreak.style.display='block';

      el('dRetail').textContent = money(retail);
      el('dDown').textContent = money(down);
      el('dBal').textContent = money(balance);
      el('dMonthly').textContent = money(monthly);
      el('dTax').textContent = money(devTax);
      el('dDue').textContent = money(devDue);
      el('dFull').textContent = money(devFull);

      // show combined rows only if accessories are present and the corresponding checkbox is checked
      const hasAcc = (elig>0 || nod>0);
      el('dCombinedRow1').style.display = (hasAcc && addAccToDue.checked) ? 'flex' : 'none';
      el('dCombinedRow2').style.display = (hasAcc && addAccToFull.checked) ? 'flex' : 'none';
      el('dDueCombined').textContent = money(combinedDue);
      el('dFullCombined').textContent = money(combinedFull);

      // note row
      if (noteText){
        el('dNote').style.display='flex';
        el('dNoteText').textContent = noteText;
      } else {
        el('dNote').style.display='none';
      }
    }

    // theme button (simple invert)
    el('themeBtn').addEventListener('click', ()=>{
      document.body.classList.toggle('dark-mode');
      el('themeBtn').textContent = document.body.classList.contains('dark-mode') ? '‚òÄÔ∏è' : 'üåô';
    });

  </script>
</body>
</html>
